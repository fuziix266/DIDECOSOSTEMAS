<?php

/**
 * Vista: Panel de administración - Lista de códigos QR
 * Ruta: /vehiculos/admin
 */
$codigos = $this->codigos ?? [];
$total = $this->total ?? 0;
$currentPage = $this->currentPage ?? 1;
$totalPages = $this->totalPages ?? 1;
$usuario = $this->usuario ?? null;
$baseUrl = '/vehiculos/public/vehiculos/admin';
?>



<div class="alert alert-info d-flex align-items-start">
    <i class="bi bi-info-circle-fill fs-3 text-primary me-3"></i>
    <div class="align-self-center">
        <p class="mb-0 small">Ante cualquier problema, informar al correo de <a href="mailto:gestiondigital.dideco@municipalidadarica.cl">gestiondigital.dideco@municipalidadarica.cl</a></p>
    </div>
</div>

<div>
    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-qr-code me-2"></i>
                        Total QR
                    </h5>
                    <h2 class="mb-0"><?= $total ?></h2>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-check-circle me-2"></i>
                        Habilitados
                    </h5>
                    <h2 class="mb-0">
                        <?php
                        $habilitados = array_filter($codigos, fn($qr) => $qr['estado'] === 'HABILITADO');
                        echo count($habilitados);
                        ?>
                    </h2>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-x-circle me-2"></i>
                        Deshabilitados
                    </h5>
                    <h2 class="mb-0">
                        <?php
                        $deshabilitados = array_filter($codigos, fn($qr) => $qr['estado'] === 'DESHABILITADO');
                        echo count($deshabilitados);
                        ?>
                    </h2>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Sin Registro
                    </h5>
                    <h2 class="mb-0">
                        <?php
                        $sinRegistro = array_filter($codigos, fn($qr) => empty($qr['registro']));
                        echo count($sinRegistro);
                        ?>
                    </h2>
                </div>
            </div>
        </div>
    </div>

    <div class="mb-4">
        <div class="input-group search-input">
            <input type="text" class="form-control buscador" placeholder="Buscar ...">
            <button class="btn btn-outline-secondary" type="button"><i class="bi bi-search"></i></button>
        </div>
    </div>

    <!-- Tabla de códigos QR -->
    <div class="bg-transparent border-0 shadow-none p-0">
        <?php if (empty($codigos)): ?>
            <div class="alert alert-info text-center py-5">
                <i class="bi bi-inbox" style="font-size: 4rem;"></i>
                <h4 class="mt-3">No hay códigos QR registrados</h4>
                <p class="mb-3">Genera tu primer lote de códigos QR para comenzar</p>
                <a href="/vehiculos/public/vehiculos/admin/generar-lote" class="btn btn-success">
                    <i class="bi bi-plus-circle me-2"></i>
                    Generar Ahora
                </a>
            </div>
        <?php else: ?>
            <div class="table-responsive">
                <table id="tablaQR" class="table table-striped table-hover align-middle" style="width:100%">
                    <thead>
                        <tr>
                            <th>UUID</th>
                            <th>Estado</th>
                            <th>Patente</th>
                            <th>Funcionario</th>
                            <th>Unidad</th>
                            <th>Creado</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($codigos as $qr): ?>
                            <tr>
                                <td>
                                    <code class="text-primary"><?= $this->escapeHtml(substr($qr['uuid_qr'], 0, 8)) ?>...</code>
                                </td>
                                <td>
                                    <?php if ($qr['estado'] === 'HABILITADO'): ?>
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle me-1"></i>
                                            HABILITADO
                                        </span>
                                    <?php elseif ($qr['estado'] === 'DESHABILITADO'): ?>
                                        <span class="badge bg-danger">
                                            <i class="bi bi-x-circle me-1"></i>
                                            DESHABILITADO
                                        </span>
                                    <?php else: ?>
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-clock me-1"></i>
                                            PENDIENTE
                                        </span>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <?php if (!empty($qr['registro']['patente'])): ?>
                                        <strong><?= $this->escapeHtml($qr['registro']['patente']) ?></strong>
                                    <?php else: ?>
                                        <span class="text-muted">-</span>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <?php if (!empty($qr['registro'])): ?>
                                        <?= $this->escapeHtml($qr['registro']['nombres'] . ' ' . $qr['registro']['apellidos']) ?>
                                    <?php else: ?>
                                        <span class="text-muted">Sin registro</span>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <?php if (!empty($qr['registro']['unidad'])): ?>
                                        <small><?= $this->escapeHtml($qr['registro']['unidad']) ?></small>
                                    <?php else: ?>
                                        <span class="text-muted">-</span>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <small><?= date('d/m/Y', strtotime($qr['fecha_creacion'])) ?></small>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm">
                                        <button type="button"
                                            class="btn btn-outline-primary"
                                            onclick="verDetalles('<?= $this->escapeJs($qr['uuid_qr']) ?>')"
                                            title="Ver diseño del QR">
                                            <i class="bi bi-eye"></i>
                                        </button>

                                        <button type="button"
                                            class="btn btn-outline-warning"
                                            onclick="editarDatos('<?= $this->escapeJs($qr['uuid_qr']) ?>', <?= $qr['id'] ?>)"
                                            title="Editar datos del registro">
                                            <i class="bi bi-pencil"></i>
                                        </button>

                                        <?php if ($qr['estado'] === 'HABILITADO'): ?>
                                            <button type="button"
                                                class="btn btn-outline-danger"
                                                onclick="cambiarEstado('<?= $this->escapeJs($qr['uuid_qr']) ?>', 'DESHABILITADO')"
                                                title="Deshabilitar QR">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        <?php else: ?>
                                            <button type="button"
                                                class="btn btn-outline-success"
                                                onclick="cambiarEstado('<?= $this->escapeJs($qr['uuid_qr']) ?>', 'HABILITADO')"
                                                title="Habilitar QR">
                                                <i class="bi bi-check-circle"></i>
                                            </button>
                                        <?php endif; ?>
                                    </div>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        <?php endif; ?>
    </div>
</div>

<!-- Modal para ver diseño del QR -->
<div class="modal fade" id="modalVerQr" tabindex="-1" aria-labelledby="modalVerQrLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalVerQrLabel">
                    <i class="bi bi-qr-code"></i> Código QR - Diseño de Impresión
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center" id="modalQrContent">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cerrar
                </button>
                <button type="button" class="btn btn-success" id="btnDescargarQrModal">
                    <i class="bi bi-download"></i> Descargar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar datos del QR -->
<div class="modal fade" id="modalEditarDatos" tabindex="-1" aria-labelledby="modalEditarDatosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalEditarDatosLabel">
                    <i class="bi bi-pencil-square"></i> Editar Datos del Registro QR
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" id="modalEditarContent">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnGuardarCambios">
                    <i class="bi bi-save"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    async function verDetalles(uuid) {
        // Abrir modal
        const modal = new bootstrap.Modal(document.getElementById('modalVerQr'));
        modal.show();

        // Mostrar spinner
        const content = document.getElementById('modalQrContent');
        content.innerHTML = `
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-muted">Generando vista previa...</p>
    `;

        try {
            // Generar el diseño del QR (57mm x 93mm = 215px x 351px a 96 DPI)
            const qrUrl = `https://www.didecoarica.cl/vehiculos/qr/${uuid}`;

            // Crear canvas oculto para generar la imagen
            const canvas = document.createElement('canvas');
            // 57mm x 93mm a 300 DPI para buena calidad de impresión
            canvas.width = 673; // 57mm * 300/25.4
            canvas.height = 1098; // 93mm * 300/25.4
            const ctx = canvas.getContext('2d');

            // Fondo blanco
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Cargar imagen del QR desde el endpoint local que genera la imagen
            const qrImg = new Image();
            qrImg.crossOrigin = 'anonymous';
            // Ruta local: /vehiculos/public/vehiculos/admin/qr/:uuid (ruta vehiculos-admin-qr)
            qrImg.src = '/vehiculos/public/vehiculos/admin/qr/' + uuid;

            await new Promise((resolve, reject) => {
                qrImg.onload = resolve;
                qrImg.onerror = reject;
            });

            // Dibujar el diseño en el canvas
            // Borde
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 4;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);

            // Encabezado azul
            ctx.fillStyle = '#0d47a1';
            ctx.fillRect(8, 8, canvas.width - 16, 80);

            // Texto encabezado
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('MUNICIPALIDAD DE ARICA', canvas.width / 2, 55);

            // Subtítulo
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 24px Arial';
            ctx.fillText('Identificación Vehicular', canvas.width / 2, 120);

            // QR Code (centrado)
            const qrSize = 500;
            const qrX = (canvas.width - qrSize) / 2;
            const qrY = 150;
            ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);

            // Borde del QR
            ctx.strokeStyle = '#dddddd';
            ctx.lineWidth = 2;
            ctx.strokeRect(qrX, qrY, qrSize, qrSize);

            // UUID
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 28px Courier New';
            ctx.fillText(uuid.substring(0, 8), canvas.width / 2, qrY + qrSize + 50);

            // Instrucciones
            ctx.font = '20px Arial';
            ctx.fillText('Escanee este código QR para', canvas.width / 2, qrY + qrSize + 100);
            ctx.fillText('registrar o consultar información', canvas.width / 2, qrY + qrSize + 130);
            ctx.fillText('del vehículo.', canvas.width / 2, qrY + qrSize + 160);

            // URL
            ctx.font = 'bold 20px Arial';
            ctx.fillText('www.didecoarica.cl', canvas.width / 2, qrY + qrSize + 200);

            // Convertir canvas a imagen
            const dataUrl = canvas.toDataURL('image/jpeg', 0.95);

            // Mostrar vista previa en el modal (tamaño reducido para visualización)
            content.innerHTML = `
            <div id="qrPreview">
                <img src="${dataUrl}" 
                     alt="Vista previa QR" 
                     style="width: 230px; height: auto; border: 2px solid #dee2e6; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            </div>
            <div class="mt-3">
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> 
                    Vista previa reducida | Descarga: 57mm x 93mm (673px x 1098px a 300 DPI)
                </small>
            </div>
        `;

            // Configurar botón de descarga para descargar la imagen generada
            document.getElementById('btnDescargarQrModal').onclick = () => {
                const link = document.createElement('a');
                link.download = `QR_${uuid.substring(0, 8)}.jpg`;
                link.href = dataUrl;
                link.click();
            };

        } catch (error) {
            console.error('Error al generar QR:', error);
            content.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                Error al cargar el código QR. Por favor, intente nuevamente.
            </div>
        `;
        }
    }

    async function descargarQr(uuid) {
        window.open('/vehiculos/public/vehiculos/admin/descargar-qr?uuid=' + uuid, '_blank');
    }

    async function editarDatos(uuid, qrId) {
        // Abrir modal
        const modal = new bootstrap.Modal(document.getElementById('modalEditarDatos'));
        modal.show();

        // Mostrar spinner
        const content = document.getElementById('modalEditarContent');
        content.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Cargando datos del registro...</p>
        </div>
    `;

        try {
            // Obtener datos del registro
            const response = await fetch('/vehiculos/public/vehiculos/admin/obtener-datos?uuid=' + uuid);
            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error || 'No se pudieron cargar los datos');
            }

            const registro = data.registro || {};

            // Crear formulario de edición
            content.innerHTML = `
            <form id="formEditarDatos">
                <input type="hidden" id="edit_uuid" value="${uuid}">
                <input type="hidden" id="edit_qr_id" value="${qrId}">
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Modo administrador:</strong> Puede editar todos los campos, incluyendo el correo electrónico.
                </div>
                
                <!-- Correo Electrónico -->
                <div class="mb-3">
                    <label for="edit_correo" class="form-label">
                        <i class="bi bi-envelope"></i> Correo Electrónico
                    </label>
                    <input type="email" 
                           class="form-control" 
                           id="edit_correo" 
                           value="${registro.correo_funcionario || ''}"
                           placeholder="correo@municipalidadarica.cl">
                    <small class="text-muted">Solo correos @municipalidadarica.cl</small>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="edit_nombres" class="form-label">
                            <i class="bi bi-person"></i> Nombres *
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="edit_nombres" 
                               value="${registro.nombres || ''}"
                               required>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="edit_apellidos" class="form-label">
                            <i class="bi bi-person"></i> Apellidos *
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="edit_apellidos" 
                               value="${registro.apellidos || ''}"
                               required>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="edit_rut" class="form-label">
                            <i class="bi bi-card-text"></i> RUT
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="edit_rut" 
                               value="${registro.rut || ''}"
                               placeholder="12.345.678-9">
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="edit_celular" class="form-label">
                            <i class="bi bi-phone"></i> Celular *
                        </label>
                        <input type="tel" 
                               class="form-control" 
                               id="edit_celular" 
                               value="${registro.celular || ''}"
                               placeholder="+56912345678"
                               required>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label for="edit_unidad" class="form-label">
                            <i class="bi bi-building"></i> Unidad/Departamento
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="edit_unidad" 
                               value="${registro.unidad || ''}"
                               placeholder="Ej: DIDECO, Dirección de Obras">
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="edit_anexo" class="form-label">
                            <i class="bi bi-telephone"></i> Anexo
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="edit_anexo" 
                               value="${registro.anexo || ''}"
                               placeholder="1234">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="edit_cargo" class="form-label">
                        <i class="bi bi-briefcase"></i> Cargo
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="edit_cargo" 
                           value="${registro.cargo || ''}"
                           placeholder="Ej: Inspector Municipal">
                </div>
                
                <div class="mb-3">
                    <label for="edit_patente" class="form-label">
                        <i class="bi bi-car-front"></i> Patente
                    </label>
                    <input type="text" 
                           class="form-control text-uppercase" 
                           id="edit_patente" 
                           value="${registro.patente || ''}"
                           placeholder="ABCD12">
                </div>
                
                <div class="mb-3">
                    <label for="edit_observaciones" class="form-label">
                        <i class="bi bi-chat-text"></i> Observaciones
                    </label>
                    <textarea class="form-control" 
                              id="edit_observaciones" 
                              rows="3"
                              placeholder="Observaciones adicionales...">${registro.observaciones || ''}</textarea>
                </div>
                
                <div class="text-muted small">
                    <i class="bi bi-asterisk"></i> Campos obligatorios
                </div>
            </form>
        `;

            // Configurar botón de guardar
            document.getElementById('btnGuardarCambios').onclick = async () => {
                await guardarCambiosRegistro();
            };

        } catch (error) {
            console.error('Error al cargar datos:', error);
            content.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                Error al cargar los datos: ${error.message}
            </div>
        `;
        }
    }

    async function guardarCambiosRegistro() {
        const uuid = document.getElementById('edit_uuid').value;
        const qrId = document.getElementById('edit_qr_id').value;

        // Validar campos obligatorios
        const nombres = document.getElementById('edit_nombres').value.trim();
        const apellidos = document.getElementById('edit_apellidos').value.trim();
        const celular = document.getElementById('edit_celular').value.trim();
        const correo = document.getElementById('edit_correo').value.trim();

        if (!nombres || !apellidos || !celular || !correo) {
            APP.Utils.showAlert('Error', 'Por favor complete todos los campos obligatorios (nombres, apellidos, celular, correo)', 'error');
            return;
        }

        // Validar dominio del correo
        if (!correo.endsWith('@municipalidadarica.cl')) {
            APP.Utils.showAlert('Error', 'El correo debe ser del dominio @municipalidadarica.cl', 'error');
            return;
        }

        try {
            const formData = new FormData();
            formData.append('uuid', uuid);
            formData.append('correo_funcionario', correo);
            formData.append('nombres', nombres);
            formData.append('apellidos', apellidos);
            formData.append('rut', document.getElementById('edit_rut').value.trim());
            formData.append('celular', celular);
            formData.append('unidad', document.getElementById('edit_unidad').value.trim());
            formData.append('anexo', document.getElementById('edit_anexo').value.trim());
            formData.append('cargo', document.getElementById('edit_cargo').value.trim());
            formData.append('patente', document.getElementById('edit_patente').value.trim().toUpperCase());
            formData.append('observaciones', document.getElementById('edit_observaciones').value.trim());

            const response = await APP.ApiService.postForm(
                '/vehiculos/public/vehiculos/admin/guardar-edicion',
                formData
            );

            if (response.success) {
                APP.Utils.showToast('Datos actualizados correctamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalEditarDatos')).hide();
                setTimeout(() => location.reload(), 1000);
            } else {
                APP.Utils.showAlert('Error', response.error || 'No se pudieron guardar los cambios', 'error');
            }
        } catch (error) {
            console.error('Error al guardar:', error);
            APP.Utils.showAlert('Error', 'Error al guardar los cambios', 'error');
        }
    }

    async function cambiarEstado(uuid, nuevoEstado) {
        const accion = nuevoEstado === 'HABILITADO' ? 'habilitar' : 'deshabilitar';

        const confirmado = await APP.Utils.showConfirm(
            'Cambiar Estado',
            `¿Deseas ${accion} este código QR?`
        );

        if (confirmado) {
            try {
                const formData = new FormData();
                formData.append('uuid', uuid);
                formData.append('estado', nuevoEstado);

                const response = await APP.ApiService.postForm(
                    '/vehiculos/public/vehiculos/admin/cambiar-estado',
                    formData
                );

                if (response.success) {
                    APP.Utils.showToast('Estado actualizado correctamente', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    APP.Utils.showAlert('Error', response.message || 'No se pudo cambiar el estado', 'error');
                }
            } catch (error) {
                APP.Utils.showAlert('Error', 'Error al cambiar el estado', 'error');
            }
        }
    }

    // Inicializar DataTables de forma robusta: reintenta hasta que el plugin esté cargado
    (function() {
        function initTablaQR() {
            if (typeof $.fn.DataTable === 'undefined') {
                // DataTables aún no cargado, reintentar
                setTimeout(initTablaQR, 100);
                return;
            }

            <?php if (!empty($codigos)): ?>
                if (!$.fn.dataTable.isDataTable('#tablaQR')) {
                    var tabla = $('#tablaQR').DataTable({
                        language: {
                            url: '/vehiculos/public/vehiculos/vendors/datatables/js/es-ES.json'
                        },
                        responsive: true,
                        pageLength: 10,
                        lengthMenu: [
                            [10, 25, 50, 100, -1],
                            [10, 25, 50, 100, "Todos"]
                        ],
                        order: [
                            [5, 'desc']
                        ], // Ordenar por fecha de creación (columna 5) descendente
                        columnDefs: [{
                            targets: 6, // Columna de acciones
                            orderable: false,
                            searchable: false
                        }],
                        // removemos el filtro integrado 'f' para usar nuestro buscador externo
                        dom: '<"row"<"col-sm-12 col-md-6"l>>rtip',
                        drawCallback: function() {
                            // Mantener los tooltips después de redibujar
                            $('[title]').tooltip();
                        }
                    });

                    // Enlazar buscador externo (input .buscador) al DataTable
                    (function() {
                        var $input = $('.search-input .buscador');
                        var $btn = $('.search-input button');

                        function debounce(fn, wait) {
                            var t;
                            return function() {
                                var args = arguments;
                                clearTimeout(t);
                                t = setTimeout(function() {
                                    fn.apply(null, args);
                                }, wait);
                            };
                        }

                        var buscar = debounce(function(val) {
                            tabla.search(val).draw();
                        }, 250);

                        // input: buscar al escribir
                        $input.off('input.dtExt').on('input.dtExt', function(e) {
                            buscar(this.value);
                        });

                        // botón: ejecutar búsqueda al click
                        $btn.off('click.dtExt').on('click.dtExt', function() {
                            tabla.search($input.val()).draw();
                        });

                        // si ya hay valor en el input al inicializar, aplicarlo
                        if ($input.val()) {
                            tabla.search($input.val()).draw();
                        }
                    })();
                }
            <?php endif; ?>
        }

        // Ejecutar cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTablaQR);
        } else {
            initTablaQR();
        }
    })();
</script>

<!-- DataTables: cargado globalmente desde el layout principal -->